@using SystemeNote.Utils
@model PaginatedList<SystemeNote.Models.NoteEtudiant>

@{
    ViewData["Title"] = ViewData["Title"] ?? "Liste des Notes";
}

<h1>@ViewData["Title"]</h1>

<form asp-action="Index" method="get" class="mb-3">
    <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label">Recherche</label>
            <input type="text" name="SearchString" value="@ViewData["CurrentFilter"]" placeholder="Matricule, nom, matière..." class="form-control" />
        </div>
        <div class="col-md-2">
            <label class="form-label">Promotion</label>
            <select name="PromotionFilter" class="form-select">
                <option value="">Toutes</option>
                @foreach (var promotion in (SelectList)ViewData["PromotionList"]!)
                {
                    <option value="@promotion.Value" selected="@(promotion.Value == ViewData["PromotionFilter"]?.ToString())">@promotion.Text</option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Matière</label>
            <select name="MatiereFilter" class="form-select">
                <option value="">Toutes</option>
                @foreach (var matiere in (SelectList)ViewData["MatiereList"]!)
                {
                    <option value="@matiere.Value" selected="@(matiere.Value == ViewData["MatiereFilter"]?.ToString())">@matiere.Text</option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Note Min</label>
            <input type="number" name="MinNote" value="@ViewData["MinNote"]" min="0" max="20" step="0.01" class="form-control" placeholder="0" />
        </div>
        <div class="col-md-2">
            <label class="form-label">Note Max</label>
            <input type="number" name="MaxNote" value="@ViewData["MaxNote"]" min="0" max="20" step="0.01" class="form-control" placeholder="20" />
        </div>
        <div class="col-md-1 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Filtrer</button>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col">
            <a asp-action="Index" class="btn btn-secondary btn-sm">Réinitialiser</a>
        </div>
    </div>
</form>

<p>
    <a asp-action="Create" class="btn btn-success">Créer Nouveau</a>
    <a asp-action="UploadNoteEtudiants" asp-controller="Upload" class="btn btn-info">Import Notes</a>
</p>

<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>
                <a asp-action="Index" 
                   asp-route-sortOrder="@ViewData["EtudiantSortParm"]" 
                   asp-route-searchString="@ViewData["CurrentFilter"]"
                   asp-route-promotionFilter="@ViewData["PromotionFilter"]"
                   asp-route-matiereFilter="@ViewData["MatiereFilter"]"
                   asp-route-minNote="@ViewData["MinNote"]"
                   asp-route-maxNote="@ViewData["MaxNote"]">
                    Étudiant
                </a>
            </th>
            <th>
                <a asp-action="Index" 
                   asp-route-sortOrder="@ViewData["MatiereSortParm"]" 
                   asp-route-searchString="@ViewData["CurrentFilter"]"
                   asp-route-promotionFilter="@ViewData["PromotionFilter"]"
                   asp-route-matiereFilter="@ViewData["MatiereFilter"]"
                   asp-route-minNote="@ViewData["MinNote"]"
                   asp-route-maxNote="@ViewData["MaxNote"]">
                    Matière
                </a>
            </th>
            <th>UE</th>
            <th>
                <a asp-action="Index" 
                   asp-route-sortOrder="@ViewData["NoteSortParm"]" 
                   asp-route-searchString="@ViewData["CurrentFilter"]"
                   asp-route-promotionFilter="@ViewData["PromotionFilter"]"
                   asp-route-matiereFilter="@ViewData["MatiereFilter"]"
                   asp-route-minNote="@ViewData["MinNote"]"
                   asp-route-maxNote="@ViewData["MaxNote"]">
                    Note
                </a>
            </th>
            <th>
                <a asp-action="Index" 
                   asp-route-sortOrder="@ViewData["PromotionSortParm"]" 
                   asp-route-searchString="@ViewData["CurrentFilter"]"
                   asp-route-promotionFilter="@ViewData["PromotionFilter"]"
                   asp-route-matiereFilter="@ViewData["MatiereFilter"]"
                   asp-route-minNote="@ViewData["MinNote"]"
                   asp-route-maxNote="@ViewData["MaxNote"]">
                    Promotion
                </a>
            </th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>
                    <strong>@item.Etudiant?.Matricule</strong><br />
                    <small class="text-muted">@item.Etudiant?.Nom @item.Etudiant?.Prenom</small>
                </td>
                <td>
                    <strong>@item.ParcoursEtude?.Matiere?.NomMatiere</strong><br />
                    <small class="text-muted">@item.ParcoursEtude?.Matiere?.CodeMatiere</small>
                </td>
                <td>@item.ParcoursEtude?.UniteEnseignement?.CodeUniteEnseignement</td>
                <td>
                    <span class="badge @(item.Note >= 10 ? "bg-success" : "bg-danger")">
                        @item.Note.ToString("F2")
                    </span>
                </td>
                <td>@item.Promotion?.NomPromotion</td>
                <td>
                    <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-warning">Modifier</a>
                    <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-info">Détails</a>
                    <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-danger">Supprimer</a>
                </td>
            </tr>
        }
    </tbody>
</table>

@{
    var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
    var nextDisabled = !Model.HasNextPage ? "disabled" : "";
}

<nav aria-label="Page navigation">
    <ul class="pagination">
        <li class="page-item @prevDisabled">
            <a asp-action="Index"
               asp-route-sortOrder="@ViewData["CurrentSort"]"
               asp-route-pageNumber="@(Model.PageIndex - 1)"
               asp-route-searchString="@ViewData["CurrentFilter"]"
               asp-route-promotionFilter="@ViewData["PromotionFilter"]"
               asp-route-matiereFilter="@ViewData["MatiereFilter"]"
               asp-route-minNote="@ViewData["MinNote"]"
               asp-route-maxNote="@ViewData["MaxNote"]"
               class="page-link">
                Précédent
            </a>
        </li>
        @for (int i = 1; i <= Model.TotalPages; i++)
        {
            <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                <a asp-action="Index"
                   asp-route-sortOrder="@ViewData["CurrentSort"]"
                   asp-route-pageNumber="@i"
                   asp-route-searchString="@ViewData["CurrentFilter"]"
                   asp-route-promotionFilter="@ViewData["PromotionFilter"]"
                   asp-route-matiereFilter="@ViewData["MatiereFilter"]"
                   asp-route-minNote="@ViewData["MinNote"]"
                   asp-route-maxNote="@ViewData["MaxNote"]"
                   class="page-link">
                    @i
                </a>
            </li>
        }
        <li class="page-item @nextDisabled">
            <a asp-action="Index"
               asp-route-sortOrder="@ViewData["CurrentSort"]"
               asp-route-pageNumber="@(Model.PageIndex + 1)"
               asp-route-searchString="@ViewData["CurrentFilter"]"
               asp-route-promotionFilter="@ViewData["PromotionFilter"]"
               asp-route-matiereFilter="@ViewData["MatiereFilter"]"
               asp-route-minNote="@ViewData["MinNote"]"
               asp-route-maxNote="@ViewData["MaxNote"]"
               class="page-link">
                Suivant
            </a>
        </li>
    </ul>
</nav>

<p>
    Page @Model.PageIndex sur @Model.TotalPages
</p>